<div class="container">
    <% if (error != undefined || error != null) { %>
      <div class="notification is-danger is-light" id="error">
          <%= error %>
      </div>
    <% } %>
    <h4 class="title is-4">Importar Productos</h4>
    <hr>
    <div class="columns is-gapless">
        <div class="column">
            <div class="box">  
                <div id="tabs-with-content">
                    <div class="tabs is-centered">
                      <ul>
                        <li><a>CSV</a></li>
                        <li><a>INTEGRACIONES</a></li>
                      </ul>
                    </div>
                    <div>
                      <section class="tab-content">
                        <form action="/import" method="POST" enctype="multipart/form-data">
                        <div class="field">
                            <label class="label">Tipo de Importaci칩n</label>
                            <div class="select is-fullwidth">
                                <select name="entity" required>
                                    <option value="Product">Productos</option>
                                    <option value="ProductVariation">Variaciones de Producto</option>
                                    <option value="ProductImage">Imagenes de Producto</option>
                                </select>
                            </div>
                        </div>
                        <div class="field">
                            <div id="file-loader" class="file has-name is-fullwidth">
                            <label class="file-label">
                                <input class="file-input" required accept=".csv" type="file" id="file" name="file" />
                                <span class="file-cta">
                                <span class="file-icon">
                                    <i class="bx bx-upload"></i>
                                </span>
                                <span class="file-label">
                                    Archivo CSV
                                </span>
                                </span>
                                <span class="file-name has-text-grey">
                                Cargar Archivo a Procesar
                                </span>
                            </label>
                            </div>
                        </div> 
                        <div class="control buttons is-right">
                            <button id="process" type="submit" class="button is-primary"><i class="bx bx-plus-circle"></i>&nbsp;Importar Archivo</button>
                        </div>  
                        </form>
                      </section>
                      <section class="tab-content">
                        <% woocommerce = null; %>
                        <%if(integrations.length>0){%>
                            <% woocommerce=integrations.filter(data => data.channel=='woocommerce')[0];%>
                            <form action="/import" method="POST" enctype="multipart/form-data">
                              <%if(sellers.length>0){%>
                                <div class="field">
                                  <label class="label">Seller</label>
                                  <div class="select is-fullwidth">
                                      <select name="seller" required>
                                        <% for(var i=0; i<sellers.length; i++) {%>
                                          <option value="<%=sellers[i].id%>"><%=sellers[i].name%></option>
                                         <% } %>
                                      </select>
                                  </div>
                                </div>
                                <% } %>
                                <div class="field">
                                    <div class="control">
                                      <label class="label">Proveedor</label>
                                      <input type="text" disabled class="input is-primary" type="text"  placeholder="Primary input" <%if(woocommerce!==null){%>value="<%=woocommerce.channel%>"<%}%> />
                                      <input type="hidden" name="channel" <%if(woocommerce!==null){%>value="<%=woocommerce.channel%>"<%}%>>
                                    </div>
                                </div>
                                <div class="field">
                                    <div class="control">
                                      <label class="label">Url</label>
                                      <input type="text" disabled class="input is-primary"  type="text" placeholder="Primary input" <%if(woocommerce!==null){%>value="<%=woocommerce.url%>"<%}%> />
                                      <input type="hidden" name="apiUrl" <%if(woocommerce!==null){%>value="<%=woocommerce.url%>"<%}%>>
                                    </div>
                                </div>
                                <div class="control buttons is-right">
                                    <input type="hidden" name="pk" <%if(woocommerce!==null){%>value="<%=woocommerce.key%>"<%}%>>
                                    <input type="hidden" name="sk" <%if(woocommerce!==null){%>value="<%=woocommerce.secret%>"<%}%>>
                                    <button id="process-from-provider" type="submit" class="button is-primary"><i class="bx bx-plus-circle"></i>&nbsp;Importar Productos</button>
                                </div> 
                            </form>
                        <%}%>
                      </section>
                    </div>
                  </div>
                <br>
            </div>
        </div>
        <div class="column">
            <div class="container is-fluid">
                <div class="loading"></div>
            <%if(typeof resultados === 'object'){%>
                <br>
                <h6 class="title is-6">Resultados del Proceso</h6>
                <hr>
                <div class="notification is-primary">
                    Se han procesado un total de <%=resultados.items.length%> registros.
                </div>
                <%if(resultados.errors !== undefined && resultados.errors.length>0){%>
                    <div class="notification is-danger">
                        <p>Hemos identificado <%=resultados.errors.length%> error(es).</p>
                        <br>
                        <div class="container is-fluid">
                            <ol>
                            <% resultados.errors.forEach(error =>{%>
                                <% if(error.message){ %>
                                  <li><%=error.message%></li>
                                <%} else {%>
                                  <li><%=error%></li>
                                <% } %>
                            <%})%>
                            </ol>
                        </div>
                    </div>
                <%}%>
            <%}%>
            </div>
        </div>
    </div>
  </div>
  <script>
    const fileInput = document.querySelector('#file-loader input[type=file]');
    fileInput.onchange = () => {
    if (fileInput.files.length > 0) {
        const fileName = document.querySelector('#file-loader .file-name');
        fileName.textContent = fileInput.files[0].name;
    }
    };
    live('#process','click',e=>{
        let box = document.querySelector('.box').parentNode;
        addClass(box,'is-hidden');
        document.querySelector('.loading').innerHTML='<br><p>Por favor espera, estamos procesando el archivo. Tomar치 unos minutos.</p><br><progress class="progress is-small is-primary" max="100">15%</progress>';
    });

    live('#process-from-provider','click',e=>{
        let box = document.querySelector('.box').parentNode;
        addClass(box,'is-hidden');
        document.querySelector('.loading').innerHTML='<br><p>Por favor espera, estamos procesando la importaci칩n. Tomar치 unos minutos.</p><br><progress class="progress is-small is-primary" max="100">15%</progress>';
    });

    live('select[name="entity"]','change',e=>{
        let elm = document.querySelector('#file');
        if(e.target.value==='ProductImage'){
            elm.setAttribute('accept','image/*');
            elm.setAttribute('multiple','multiple');
            document.querySelector('span .file-label').innerHTML='Imagenes a Procesar'
            document.querySelector('.file-name').innerHTML='Cargar Varias Imagenes'
        }else{
            elm.setAttribute('accept','.csv');
            elm.removeAttribute('multiple');
            document.querySelector('span .file-label').innerHTML='Archivo .CSV'
            document.querySelector('.file-name').innerHTML='Cargar Archivo .csv a procesar'
        }
    })

    document.addEventListener("DOMContentLoaded", function(event) {
        let tabsWithContent = (function () {
  let tabs = document.querySelectorAll('.tabs li');
  let tabsContent = document.querySelectorAll('.tab-content');

  let deactvateAllTabs = function () {
    tabs.forEach(function (tab) {
      tab.classList.remove('is-active');
    });
  };

  let hideTabsContent = function () {
    tabsContent.forEach(function (tabContent) {
      tabContent.classList.remove('is-active');
    });
  };

  let activateTabsContent = function (tab) {
    tabsContent[getIndex(tab)].classList.add('is-active');
  };

  let getIndex = function (el) {
    return [...el.parentElement.children].indexOf(el);
  };

  tabs.forEach(function (tab) {
    tab.addEventListener('click', function () {
      deactvateAllTabs();
      hideTabsContent();
      tab.classList.add('is-active');
      activateTabsContent(tab);
    });
  })

  tabs[0].click();
})();
    });
  </script>