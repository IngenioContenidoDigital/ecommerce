<link href='https://cdn.jsdelivr.net/npm/bulma-tooltip@3.0.2/dist/css/bulma-tooltip.min.css' rel='stylesheet'>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
<div class="container">
  <% if (error != undefined || error != null) { %>
    <div class="notification is-danger is-light" id="error">
      <%= error %>
    </div>
  <% } %>
  <% if (success != undefined || success != null) { %>
    <div class="notification is-success is-light" id="success">
      <%= success %>
    </div>
  <% } %>
  <% if(action=='create' || action=='edit'){ %>
    <div class="box">
      <div class="columns is-mobile is-vcentered">
        <% if(action=='edit'){ %>
        <div class="column">
          <p class="has-text-left"><img height="100" src="<%=imgurl%>/images/sellers/<%= seller.logo %>" /></p>
        </div>
        <% } %>
      </div>
      <div class="product-tab tabs">
        <ul>
          <li class="is-active"><a option="infobasics" >Información General</a></li>
          <li <%if(action!='edit'){%>class="is-hidden"<%}%>><a option="integrations">Integraciones</a></li>
          <li <%if(action!='edit'){%>class="is-hidden"<%}%>><a option="commissions">Comisiones</a></li>
        </ul>
      </div>
      <div id ="infobasics">
        <% if(action=='create') { %>
          <form action="/seller/create" method="POST" enctype="multipart/form-data" novalidate>
        <% } %>
        <% if(action=='edit') { %>
          <form action="/seller/edit/<%= seller.id %>" method="POST" enctype="multipart/form-data" novalidate>
        <% } %>
          <div class="columns">
            <div class="column">
              <label class="label is-inline is-size-7" for="name">Nombre del Comercio</label>&nbsp;
              <div class="field is-pulled-right">
                <% if(action=='edit'){ %>
                  <input id="activo" type="checkbox" <% if(seller.active){ %><%= checked="checked" %><% } %> name="activo" class="switch is-rounded is-outlined">
                  <label for="activo">Seller: <span id="state"><% if(seller.active){ %> <b style="color:green;">activo</b> <% } else { %> <b style="color:red;">inactivo</b> <% } %></span></label>
                <% }else{ %>
                  <input id="activo" type="checkbox" checked="checked" name="activo" class="switch is-rounded is-outlined">
                  <label for="activo">Seller: <span id="state"><b style="color:green;">activo</b></span></label>  
                <% } %>
              </div>
              <div class="control">
                <input class="input is-size-7" type="text" name="name" required="true" placeholder="Nombre del Seller" <% if(action=='edit'){ %>value="<%= seller.name %>"<% }%>/>
              </div>
            </div>           
          </div>
          <div class="columns">
            <div class="column">
              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label is-size-7">Identificación</label>
                    <div class="control">
                      <input class="input is-size-7" type="text" name="dni" required="true" placeholder="NIT del Comercio" <% if(action=='edit'){ %>value="<%= seller.dni %>"<% }%>/>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label is-size-7">Tag Manager</label>
                    <div class="control">
                      <input class="input is-size-7" type="text" name="tagManager" placeholder="ID de Google Tag manager" <% if(action=='edit'){ %>value="<%= seller.tagManager %>"<% }%>/>
                    </div>
                  </div>
                </div>
              </div>
              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label is-size-7">Nombre del Contacto</label>
                    <div class="control">
                      <input class="input is-size-7" type="text" name="contact" required="true" placeholder="Nombre del contacto principal" <% if(action=='edit'){ %>value="<%= seller.contact %>"<% }%>/>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label is-size-7">Email de Contacto</label>
                    <div class="control">
                      <input class="input is-size-7" type="text" name="email" required="true" placeholder="Email del contacto principal" <% if(action=='edit'){ %>value="<%= seller.email %>"<% }%>/>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label is-size-7">Teléfono</label>
                    <div class="control">
                      <input class="input is-size-7" type="text" name="phone" required="true" placeholder="Teléfono del contacto principal" <% if(action=='edit'){ %>value="<%= seller.phone %>"<% }%>/>
                    </div>
                  </div>
                </div>
              </div>
              <div class="field">
                <label class="label is-size-7">URL</label>
                <div class="control">
                  <input class="input is-size-7" type="text" name="url" required="true" placeholder="Nombre del contacto principal" <% if(action=='edit'){ %>value="<%= seller.domain %>"<% }%>/>
                </div>
              </div>
              <div class="columns">
                <div class="column">
                  <div class="field">
                    <div class="control">
                      <label class="label is-size-7">Integracion ERP</label>
                      <input id="integrationErp" type="checkbox" name="integrationErp" class="switch is-success" <% if(action=='edit' && seller.integrationErp){%>checked<%}%>>
                      <label for="integrationErp"></label>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <div class="control">
                      <label for="safestock" class="label is-size-7">Stock de Seguridad</label>
                      <input id="safestock" type="number" min="0" max="5" name="safestock" class="input is-size-7" value="<% if(action=='edit'){%><%= seller.safestock %><%}else{%>0<%}%>" >
                    </div>
                  </div>    
                </div>
              </div>
            </div>
            <div class="column">
              <div class="field">
                <label class="label is-size-7">Dirección</label>
                <div class="control">
                  <input class="input is-size-7" required name="addressline1" type="text" placeholder="Calle, Carrera, Avenida, etc..." <%if(action=='edit' && seller.mainAddress!==null){%>value="<%=seller.mainAddress.addressline1%>"<%}%>/>
                </div>
                <br>
                <div class="control">
                    <input class="input is-size-7" name="addressline2" type="text" placeholder="Torre, Casa, Piso, Puerta, Edificio..." <%if(action=='edit' && seller.mainAddress!==null){%>value="<%=seller.mainAddress.addressline2%>"<%}%>/>
                </div>
              </div>
              <div class="columns">
                <div class="column">
                  <div class="field">
                      <label class="label is-size-7">País</label>
                      <div class="control">
                        <div class="select is-fullwidth is-size-7">
                          <select required class="select is-capitalized" name="country">
                            <option value="0">Elegir País</option>
                            <% countries.forEach((country) =>{ %>
                            <option class="is-capitalized" value="<%=country.id%>" <%if(action=='edit' && seller.mainAddress!==null && country.id==seller.mainAddress.country.id){%>selected="selected"<%}%>><%=country.name%></option>
                            <%})%>
                          </select>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="column">
                  <%if(action=='edit' && seller.mainAddress!==null){%>
                    <div class="field" id="estados">
                  <%}else{%>
                    <div class="field is-hidden" id="estados">
                  <%}%>
                      <label class="label is-size-7">Estado</label>
                      <div class="select control is-size-7 is-fullwidth">
                        <select class="is-capitalized" name="region" required >
                          <option value="">-- Elegir Región --</option>
                          <%if(action=='edit' && seller.mainAddress!==null){%>
                            <option value="<%=seller.mainAddress.region.id%>" selected="selected"><%=seller.mainAddress.region.name%></option>
                          <%}%>
                        </select>
                      </div>
                    </div>
                </div>
                <div class="column">
                  <%if(action=='edit' && seller.mainAddress!==null){%>
                    <div class="field" id="ciudades">
                  <%}else{%>
                    <div class="field is-hidden" id="ciudades">
                  <%}%>
                      <label class="label is-size-7">Ciudad</label>
                      <div class="control select is-size-7 is-fullwidth">
                        <select class="is-capitalized" name="city" required>
                          <option value="">-- Elegir Ciudad --</option>
                          <%if(action=='edit' && seller.mainAddress!==null){%>
                            <option value="<%=seller.mainAddress.city.id%>" selected="selected"><%=seller.mainAddress.city.name%></option>
                          <%}%>
                        </select>
                      </div>
                    </div>
                </div>
              </div>
              <div class="columns">
                  <div class="column">
                    <div class="field">
                      <label class="label is-size-7">Código Postal</label>
                      <div class="control">
                        <input class="input is-size-7" name="zipcode" type="text" placeholder="Código Postal de la Dirección" <%if(action=='edit' && seller.mainAddress!==null){%>value="<%=seller.mainAddress.zipcode%>"<%}%>/>
                      </div>
                    </div>
                  </div>
                  <div class="column">
                    <div class="field">
                      <label class="label is-size-7">Moneda</label>
                      <div class="control">
                        <div class="select is-fullwidth is-size-7">
                          <select required class="select is-capitalized" name="currency">
                            <option value="0">Elegir Moneda</option>
                            <% currencies.forEach((currency) =>{ %>
                              <option class="is-capitalized" <%=(seller && seller.currency && seller.currency.id == currency.id) ? 'selected="selected"' : '' %> value="<%=currency.id%>"><%=currency.name%></option>
                            <%})%>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
              </div>
              <div class="field">
                <label class="label is-size-7">Detalles adicionales para ubicar la dirección</label>
                <div class="control">
                  <textarea class="textarea is-size-7" name="notes" placeholder="Detalles adicionales que puedan ser de utilidad para localizar esta dirección."><%if(action=='edit' && seller.mainAddress!==null){%><%-seller.mainAddress.notes%><%}%></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <div id="file-loader" class="file is-size-7 has-name is-fullwidth">
              <label class="file-label">
                <input class="file-input" accept="image/*" type="file" id="logo" name="logo" />
                <span class="file-cta">
                  <span class="file-icon">
                    <i class="bx bx-upload"></i>
                  </span>
                  <span class="file-label">
                    Logotipo
                  </span>
                </span>
                <span class="file-name">
                  No ha cargado ningún archivo.
                </span>
              </label>
            </div>
          </div>
          <br>
          <div class="control buttons is-right">
            <% if(action=='edit'){ %> 
              <button type="submit" class="button is-primary"><i class="bx bxs-pencil"></i>&nbsp;Modificar Seller</button>
            <% }else if (action=='create'){ %>
              <button type="submit" id="save-seller" class="button is-primary"><i class="bx bx-plus-circle"></i>&nbsp;Crear Seller</button>
            <% } %>
          </div>
        </form>
      </div>
      <div class="is-hidden" id="integrations">
        <p style="text-align: right;font-size: 15px; margin-right: 5px;">            
          <a href="#" class="has-text-primary" id="add-row"><i class="is-size-4 bx bxs-plus-square"></i></a>
        </p>
        <table class="table is-hoverable is-size-6 is-mediumwidth">
          <thead>
            <tr>
              <th><small>Integración</small></th>
              <th><small>Nombre</small></th>
              <th><small>Opciones</small></th>
            </tr>
          </thead>
          <tbody>
            <% if(integrations){%>
              <% integrations.forEach(integration => { %>
                <tr>
                  <td><img src="<%=imgurl%>/images/channels/<%= integration.channel.logo %>" width="100px"/></td>
                  <td>
                    <%= integration.name %>
                  </td>
                  <td>
                    <a href="#" class="has-text-info" id="edit-integration"><i class="is-size-4 bx bxs-edit" integrationId="<%= integration.id %>"></i></a>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
        <div id="modal-integration" class="modal">
          <div class="modal-background"></div>
          <div class="modal-card">
            <section class="modal-card-body">
              <div class="box">
                <div class="field">
                  <label class="label">Integración</label>
                  <div id="img-integrations"></div>
                </div>
                <div class="setup is-hidden" id="form-integration"></div>
              </div>
            </section>
          </div>
          <button class="modal-close is-large" aria-label="close"></button>
        </div>
        <script>
          live('#add-row','click',function(e){
            e.preventDefault();
            createColumnImages(false, '');
            cleanForm();
            let modal = document.querySelector('#modal-integration');
            addClass(modal,'is-active');
          });

          live('#edit-integration','click',function(e){
            e.preventDefault();
            const id = e.target.getAttribute('integrationId');
            const formIntegration = document.querySelector('#form-integration');
            const integrations = <%- JSON.stringify(integrations) %>;
            const integration = integrations.find(i => i.id === id);
            const chann = integration.channel.name;
            const type = integration.channel.type;
            cleanFormEdit(integration.channel);
            const idChannel = integration.channel.id
            if (type === 'cms') {
              createFormCms(idChannel, chann, integration, true);
              removeClass(formIntegration, 'is-hidden');
              validateFormCms(chann);
            } else if(type === 'marketplace'){
              createFormMarketplace(idChannel, chann, integration, true);
              removeClass(formIntegration, 'is-hidden');
            }
            let modal = document.querySelector('#modal-integration');
            addClass(modal,'is-active');
          });
        
          const fileInput = document.querySelector('#file-loader input[type=file]');
          fileInput.onchange = () => {
            if (fileInput.files.length > 0) {
              const fileName = document.querySelector('#file-loader .file-name');
              fileName.textContent = fileInput.files[0].name;
            }
          };

          live('.menu-title', 'click', e =>{
            const channel = document.querySelector('input[name="channel"]');
            const images = document.querySelectorAll('.menu-title');
            const formIntegration = document.querySelector('#form-integration');
            const chann = e.target.id;
            const idChannel = e.target.getAttribute('idChannel');
            const type = e.target.getAttribute('type');
            if (type === 'cms') {
              createFormCms(idChannel, chann, null, false);
              removeClass(formIntegration, 'is-hidden');
              validateFormCms(chann);
            } else if(type === 'marketplace'){
              createFormMarketplace(idChannel, chann, null, false);
              removeClass(formIntegration, 'is-hidden');
            }
            images.forEach(img =>{
              removeClass(img, 'img-multiple');
            });
            addClass(e.target,'img-multiple');
          });

          function validateFormCms(channel) {
            if(channel ==='prestashop'){
              let secret=document.querySelector('input[name="secret"]');
              addClass(secret,'is-hidden');
              addClass(secret.parentNode,'is-hidden');
              addClass(secret.parentNode.parentElement,'is-hidden');
              secret.value="N/A";
              let version=document.querySelector('input[name="version"]');
              addClass(version,'is-hidden');
              addClass(version.parentNode,'is-hidden');
              addClass(version.parentNode.parentElement,'is-hidden');
              version.value="N/A";
            }else if(channel ==='vtex'){
              let version=document.querySelector('input[name="version"]');
              addClass(version,'is-hidden');
              addClass(version.parentNode,'is-hidden');
              addClass(version.parentNode.parentElement,'is-hidden');
              version.value="N/A";
            }
          }
          
          function createFormCms(channel, nameChannel, integration, edit) {
            let div = document.createElement('div');
            let formIntegration = document.querySelector('#form-integration');
            formIntegration.innerHTML = '';
            <%if(action==='edit'){%>
              let form = 
              `<form method="POST" action="/integration/set/<%=seller.id%>/${channel}/${nameChannel}">
                <div class="container">
                  <input class="is-hidden" name="integration" value="${edit ? integration.id : ''}"/>
                  <div class="field">
                    <label class="label">Nombre</label>
                    <div class="control has-icons-left">
                      <input class="input is-capitalized" type="text" name="name" placeholder="Nombre" required value="${edit ? integration.name : ''}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-collapse' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Consumer key</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="key" placeholder="Consumer key" value="${edit ? integration.key : ''}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-key' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Consumer secret</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="secret" placeholder="Consumer secret" required value="${edit ? integration.secret : ''}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-key' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">URL Petición</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="url" placeholder="Url de Petición" required value="${edit ? integration.url : ''}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-world'></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Versión</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="version" placeholder="Versión" value="${edit ? integration.version : ''}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-world'></i>
                      </span>
                    </div>
                  </div>
                  <br>
                  <div class="control is-left">
                    <button type="submit" class="button is-primary is-small">${edit ? 'Actualizar Integración' : 'Guardar Integración'}</button>
                  </div>
                </div>
              </form>`
              div.innerHTML = form;
              formIntegration.appendChild(div);
            <%}%>
          }

          async function createFormMarketplace(channel, nameChannel, integration, edit) {
            let div = document.createElement('div');
            let formIntegration = document.querySelector('#form-integration');
            formIntegration.innerHTML = '';
            <%if(action==='edit'){%>
              let intname = edit ? integration.name : '';
              let intuser = edit ? integration.user : '';
              let intkey = edit ? integration.key : '';
              if(nameChannel==='iridio' && !intkey){
                intuser = '<%=seller.email%>';
                io.socket.post('/hash',{},(resData)=>{
                  document.querySelector('input[name="key"]').value = resData;
                });
              }
              let form = nameChannel === 'mercadolibre' ? 
              `<form method="POST" action="/integration/set/<%=seller.id%>/${channel}/${nameChannel}">
                <div class="container">
                  <input class="is-hidden" name="integration" value="${edit ? integration.id : ''}"/>
                  <div class="field">
                    <label class="label">Nombre</label>
                    <div class="control has-icons-left">
                      <input class="input is-capitalized" type="text" name="name" placeholder="Nombre" required value="${intname}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-collapse' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">App Id</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="user" placeholder="Id de Cliente" required value="<%= appIdMl %>" readonly/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-user-circle' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Secret Key</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="key" placeholder="Clave de API" required value="<%= secretKeyMl%>" readonly/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-key' ></i>
                      </span>
                    </div>
                  </div>
                  <br>
                  <div class="control is-right">
                    <button type="submit" class="button is-info is-small">Autorizar Acceso</button>
                  </div>
                </div>
              </form>`:
              `<form method="POST" action="/integration/set/<%=seller.id%>/${channel}/${nameChannel}">
                <div class="container">
                  <input class="is-hidden" name="integration" value="${edit ? integration.id : ''}"/>
                  <div class="field">
                    <label class="label">Nombre</label>
                    <div class="control has-icons-left">
                      <input class="input is-capitalized" type="text" name="name" placeholder="Nombre" required value="${intname}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-collapse' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Usuario</label>
                    <div class="control has-icons-left">
                    <input class="input" type="text" name="user" placeholder="Usuario de Conexión" required value="${intuser}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-user-circle' ></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">Clave de API</label>
                    <div class="control has-icons-left">
                      <input class="input" type="text" name="key" placeholder="Llave del API" required value="${intkey}"/>
                      <span class="icon is-small is-left">
                        <i class='bx bx-key' ></i>
                      </span>
                    </div>
                  </div>
                  <br>
                  <div class="control is-right">
                    <button type="submit" class="button is-primary is-small">${edit ? 'Actualizar Integración' : 'Guardar Integración'}</button>
                  </div>
                </div>
              </form>`
              div.innerHTML = form;
              formIntegration.appendChild(div);
            <%}%>
          }
          
          function createColumnImages(edit, channel) {
            let channels = <%- JSON.stringify(channels) %>;
            let div = document.createElement('div');
            let columnsIntegration = document.querySelector('#img-integrations');
            columnsIntegration.innerHTML = '';
            let content = '';
          
            if (edit) {
              content =  
                `<div class="column">
                  <img class="image-integration img-multiple" src="<%=imgurl%>/images/channels/${channel.logo}" id="${channel.name}" type="${channel.type}"/>
                </div>
                <input class="is-hidden" name="channel" value=""/>`;
            } else {
              content = `<input class="is-hidden" name="channel" value=""/>`;
              for (const channel of channels) {
                content += `<div class="column">
                <img class="menu-title image-integration" src="<%=imgurl%>/images/channels/${channel.logo}" id="${channel.name}" idChannel="${channel.id}" type="${channel.type}"/>
              </div>`
              }
            }
            addClass(div, 'columns');
            addClass(div, 'is-gapless');
            div.innerHTML = content;
            columnsIntegration.appendChild(div);
          }

          function cleanForm() {
            let channel = document.querySelector('input[name="channel"]');
            let formIntegration = document.querySelector('#form-integration');
            channel.value = '';
            formIntegration.innerHTML = '';
            cleanBorderImage();
            addClass(formIntegration, 'is-hidden');
          }
          
          function cleanFormEdit(channel) {
            let formIntegration = document.querySelector('#form-integration');
            let divImages = document.querySelector('.columns .is-gapless');
            formIntegration.innerHTML = '';
            if (divImages) {
              divImages.remove();
            }
            createColumnImages(true, channel);
          }

          function cleanBorderImage() {
            let images = document.querySelectorAll('.menu-title');
            images.forEach(img =>{
              removeClass(img, 'img-multiple');
            });
          }
        </script>
      </div>
      <div class="is-hidden" id="commissions">
        <div class="control buttons is-right">
          <button id="add-commission" class="button is-small is-rounded is-primary">
            <span class="icon is-small">
              <i class='bx bxs-briefcase'></i>
            </span>
            <span>Gestionar Comisiones</span>
          </button>
        </div>
        <%if(action==='edit'){%>
          <form method="POST" action="/commission/set/<%=seller.id%>">
            <div class="columns">
              <div class="column">
                <div class="field">
                  <label class="label is-size-7">Costo por SKU</label>
                  <div class="control has-icons-left">
                    <input class="input is-size-7" type="number" step="any" name="skuPrice" placeholder="Costo por SKU" <% if(action=='edit'){ %>value="<%= seller.skuPrice %>"<% }%>/>
                    <span class="icon-input-left is-small is-left">
                      <i class="bx bxs-badge-dollar"></i>
                    </span>
                  </div>
                </div>
              </div>
              <div class="column">
                <div class="field">
                  <div class="control">
                    <label class="label is-size-7">SKU activos</label>
                    <input id="activeSku" type="checkbox" name="activeSku" class="switch is-success" <% if(action=='edit' && seller.activeSku){%>checked<%}%>>
                    <label for="activeSku"></label>
                  </div>
                </div>
              </div>
            </div>
            <div class="control buttons">
              <button type="submit" class="button is-primary"><i class="bx bxs-pencil"></i>&nbsp;Actualizar Comisión</button>
            </div>
          </form>
          <br><br>
          <h6 class="title is-6">Comisiones por Canal</h4>
          <hr>
          <div class="columns">
            <div class="column" id="commission-container">
              <table class="table is-hoverable is-size-6 is-fullwidth">
                <thead>
                  <tr>
                    <th><small>Canal</small></th>
                    <th><small>Comisión</small></th>
                    <th><small>Opciones</small></th>
                  </tr>
                </thead>
                <tbody>
                  <% if(commissionchannel){%>
                    <% commissionchannel.forEach(commission => { %>
                      <tr>
                        <td><img src="<%=imgurl%>/images/channels/<%= commission.channel.logo %>" width="100px"/></td>
                        <td>
                          <%= commission.value %>
                        </td>
                        <td>
                          <a href="#" class="has-text-info" id="delete-commission" commissionId="<%= commission.id %>"><i class="is-size-4 bx bx-trash"></i></a>
                        </td>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
            <div class="column"></div>
          </div>
          <br><br>
          <h6 class="title is-6">Descuentos de Comisiones</h4>
          <hr>
          <div class="columns">
            <div class="column" id="discount-container">
              <table class="table is-hoverable is-size-6 is-fullwidth">
                <thead>
                  <tr>
                    <th><small>Fecha</small></th>
                    <th><small>Comisión</small></th>
                    <th><small>Opciones</small></th>
                  </tr>
                </thead>
                <tbody>
                  <% if(commissiondiscount){%>
                    <% commissiondiscount.forEach(discount => { %>
                      <tr>
                        <td><%= moment(discount.from).locale('es').format('DD MMMM YYYY HH:mm:ss'); %> - <%= moment(discount.to).locale('es').format('DD MMMM YYYY HH:mm:ss'); %></td>
                        <td>
                          <%= discount.value %>%
                        </td>
                        <td>
                          <a href="#" class="has-text-info" id="delete-discount" discountId="<%= discount.id %>"><i class="is-size-4 bx bx-trash"></i></a>
                        </td>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
            <div class="column"></div>
          </div>
          <div id="modal-commission" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
              <section class="modal-card-body">
                <div class="box">  
                  <div id="tabs-with-content">
                    <div class="tabs tabs-commission is-centered">
                      <ul>
                        <li><a>Agregar Comisión</a></li>
                        <li><a>Agregar Descuento</a></li>
                      </ul>
                    </div>
                    <section class="tab-content">
                      <form method="POST" action="/commissionchannel/<%=seller.id%>">
                        <div class="field">
                          <label class="label is-size-7">Marketplace</label>
                          <div id="img-channels"></div>
                        </div>
                        <br/>
                        <div class="field">
                          <label class="label is-size-7">Comisión por Venta</label>
                          <div class="control has-icons-left">
                            <input class="input is-size-7" id="commissionValue" type="number" step="any" name="commission" placeholder="Comisión por venta"/>
                            <span class="icon-input-left is-small is-left">
                              <i class="bx bxs-offer"></i>
                            </span>
                          </div>
                        </div>
                        <div class="control buttons is-right">
                          <button type="submit" id="btnCommission" class="button is-primary is-small"><i class="bx bx-plus-circle"></i>&nbsp;Agregar Comisión</button>
                        </div>
                      </form>
                    </section>
                    <section class="tab-content" >
                      <form method="POST" action="/commissiondiscount/create/<%=seller.id%>">
                        <div class="field">
                          <label class="label is-size-7">Comisión por Venta</label>
                          <div class="control has-icons-left">
                            <input class="input is-size-7" type="number" step="any" name="commission" placeholder="Comisión por venta"/>
                            <span class="icon-input-left is-small is-left">
                              <i class="bx bxs-offer"></i>
                            </span>
                          </div>
                        </div>
                        <div class="field">
                          <label class="label is-size-7">Intervalo de Fecha</label>
                          <div class="is-right input-datepiker">
                            <input class="input" type="date" name="range"/>
                          </div>
                        </div>
                        <div class="control buttons is-right">
                          <button type="submit" class="button is-primary is-small"><i class="bx bx-plus-circle"></i>&nbsp;Agregar Descuento</button>
                        </div>
                      </form>
                    </section>
                  </div>
                  <br>
                </div>
              </section>
            </div>
            <button class="modal-close is-large" id="close-modal"></button>
          </div>
        <% } %>
        <script>
          live('#add-commission','click',function(e){
            e.preventDefault();
            let modal = document.querySelector('#modal-commission');
            addClass(modal,'is-active');
            createImg();
          });

          live('#close-modal','click',function(e){
            e.preventDefault();
            let modal = document.querySelector('#modal-commission');
            removeClass(modal,'is-active');
          });

          live('#delete-discount','click', e =>{
            e.preventDefault();
            let elm = e.target;
            if(e.target.tagName=='I'){
              elm = e.target.parentNode;
            }
            let id = elm.getAttribute('discountId');
            io.socket.put('/removecommissiondiscount',{id},resData =>{
              if(resData=='ok'){
                let row = elm.parentNode.parentNode;
                let table = document.getElementById('discount-container').querySelector('.table')          
                table.deleteRow(row.rowIndex);
              }
            });
          });

          live('#delete-commission','click', e =>{
            e.preventDefault();
            let elm = e.target;
            if(e.target.tagName=='I'){
              elm = e.target.parentNode;
            }
            let id = elm.getAttribute('commissionId');
            io.socket.put('/removecommission',{id},resData =>{
              if(resData==='ok'){
                let row = elm.parentNode.parentNode;
                let table = document.getElementById('commission-container').querySelector('.table')          
                table.deleteRow(row.rowIndex);
              }
            });
          });

          live('.menu-channel', 'click', e =>{
            let commission = <%- JSON.stringify(commissionchannel) %>;
            const channel = document.querySelector('input[name="channel"]');
            const inputIdComm = document.querySelector('input[name="idcommission"]');
            const inputCommission = document.querySelector('#commissionValue');
            const images = document.querySelectorAll('.menu-channel');
            const btn = document.querySelector('#btnCommission');
            const chan = e.target.id;
            commission = commission.find(c => c.channel.id === chan);
            channel.value = chan;
            images.forEach(img =>{
              removeClass(img, 'img-multiple');
            });
            addClass(e.target,'img-multiple');
            if (!commission) {
              inputCommission.value = '';
              btn.innerHTML  = `<i class="bx bx-plus-circle"></i>&nbsp;Agregar Comisión`;
            } else {
              inputIdComm.value = commission.id;
              inputCommission.value = commission.value;
              btn.innerHTML  = `<i class='bx bx-edit'></i>&nbsp;Actualizar Comisión`;
            }
          });

           // Initialize all input of date type.
          const calendars = bulmaCalendar.attach('[type="date"]', {
            type:'datetime',
            isRange: true,
            allowSameDayRange: true,
            dateFormat:'YYYY-MM-DD',
            timeFormat:'HH:mm:ss',
            displayMode:'dialog',
            cancelLabel:'Cancelar',
            clearLabel:'Limpiar',
            todayLabel:'Hoy',
            nowLabel:'Ahora',
            validateLabel:'Seleccionar',
            minDate: new Date()
          });

          // Loop on each calendar initialized
          calendars.forEach(calendar => {
            // Add listener to date:selected event
            calendar.on('date:selected', date => {
              console.log(date);
            });
          });

          function createImg() {
            let channels = <%- JSON.stringify(channels) %>;
            channels = channels.filter(chan => chan.type === 'marketplace');
            let div = document.createElement('div');
            let columnsIntegration = document.querySelector('#img-channels');
            columnsIntegration.innerHTML = '';
            let content = `<input class="is-hidden" name="channel" value=""/><input class="is-hidden" name="idcommission" value=""/>`;
            for (const channel of channels) {
              content += `<div class="column">
                <img class="menu-title menu-channel image-integration" src="<%=imgurl%>/images/channels/${channel.logo}" id="${channel.id}"/>
              </div>`
            }
            addClass(div, 'columns');
            addClass(div, 'is-gapless');
            div.innerHTML = content;
            columnsIntegration.appendChild(div);
          }

          document.addEventListener("DOMContentLoaded", function(event) {
            let tabsWithContent = (function () {
              let tabs = document.querySelectorAll('.tabs-commission li');
              let tabsContent = document.querySelectorAll('.tab-content');

              let deactvateAllTabs = function () {
                tabs.forEach(function (tab) {
                  tab.classList.remove('is-active');
                });
              };

              let hideTabsContent = function () {
                tabsContent.forEach(function (tabContent) {
                  tabContent.classList.remove('is-active');
                });
              };

              let activateTabsContent = function (tab) {
                tabsContent[getIndex(tab)].classList.add('is-active');
              };

              let getIndex = function (el) {
                return [...el.parentElement.children].indexOf(el);
              };

              tabs.forEach(function (tab) {
                tab.addEventListener('click', function () {
                  deactvateAllTabs();
                  hideTabsContent();
                  tab.classList.add('is-active');
                  activateTabsContent(tab);
                });
              })
              tabs[0].click();
            })();
          });
         
        </script>
      </div>
    </div>
    <script>
      live('#activo','click',function(){
        let elm = this;
        let state = elm.checked;
        var sp = document.querySelector('#state');
        if(state){
          sp.innerHTML='<b style="color:green;">activo</b>';
        }else{
          sp.innerHTML='<b style="color:red;">inactivo</b>';
        }
      });

      live('select[name="country"]','change',e =>{
        let country = e.target.value;
        
        let regions = document.querySelector('#estados')
        regions.querySelector('select').innerHTML='<option value="">-- Elegir Región --</option>';
        addClass(regions,'is-hidden');
        
        let cities = document.querySelector('#ciudades')
        cities.querySelector('select').innerHTML='<option value="">-- Elegir Ciudad --</option>';
        addClass(cities,'is-hidden');
        
        io.socket.get('/find/regions/'+country,resdata =>{
          if(resdata.regions.length>0){
            for(let s of resdata.regions){
              let option = document.createElement('option');
              option.value = s.id;
              option.innerHTML = s.name
              regions.querySelector('select').appendChild(option);
            }
            removeClass(regions,'is-hidden');
          }
        });
      });

      live('select[name="region"]','change',e =>{
        let region = e.target.value;
        let cities = document.querySelector('#ciudades')
        cities.querySelector('select').innerHTML='<option value="">-- Elegir Ciudad --</option>';
        addClass(cities,'is-hidden');
        io.socket.get('/find/cities/'+region,resdata =>{
          if(resdata.cities.length>0){
            for(let s of resdata.cities){
              let option = document.createElement('option');
              option.value = s.id;
              option.innerHTML = s.name
              cities.querySelector('select').appendChild(option);
            }
            removeClass(cities,'is-hidden');
          }
        });
      });
      
      live('.product-tab ul li','click',(e)=>{
        e = e || window.event;
        let element = e.target || e.srcElement;
        let option = element.getAttribute('option');
        let list = element.parentNode.parentNode.querySelectorAll('li');
        list.forEach((li)=>{
          if(hasClass(li,'is-active')){
            addClass(document.querySelector('#'+li.querySelector('a').getAttribute('option')),'is-hidden');
          }
          removeClass(li,'is-active');
        });
        removeClass(document.querySelector('#'+option),'is-hidden');
        addClass(element.parentNode,'is-active');
      });
    </script>
  <% } else { %>
    <div id="loading-donwload" class="notification is-hidden">
      <i class="fas fa-sync fa-spin"></i>
        Descargando archivo...
        <progress class="progress is-small is-primary" max="100">15%</progress>
    </div>
    <p style="text-align: right;font-size: 20px; margin-right: 5px;">
      <a href="/sellers/create" class="has-text-primary"><i class='bx bxs-plus-square'></i></a>
    </p>
    <div class="table-container">
        <table class="table is-hoverable" id="sellers-table">
            <thead>
            <tr>
                <th scope="col">Logo</th>
                <th scope="col">Nombre</th>
                <th scope="col">Activo</th>
                <th scope="col">Opciones</th>
            </tr>
            </thead>
            <tbody>
              <% sellers.forEach(function(seller){ %>
                <tr>
                    <td class="align-middle">
                        <img async src="<%=imgurl%>/images/sellers/<%= seller.logo %>" name="logo" alt="<%= seller.name %>" width="150px" />
                    </td>
                    <td class="align-middle is-capitalized"><%= seller.name %></td>
                    <td class="align-middle">
                    <span class="action">
                    <% if(seller.active===true) { %>
                        <i seller="<%= seller.id %>" class="state bx bx-check-circle"></i>
                    <% }else{ %>
                        <i seller="<%= seller.id %>" class="state bx bx-x-circle"></i>
                    <%}%>
                    </span>
                    </td>
                    <td class="align-middle">
                      <a href="/sellers/edit/<%= seller.id %>" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Configurar Seller">
                          <span class="icon">
                          <i class="bx bxs-cog"></i>
                          </span>
                      </a>
                      <%if(req.session.user.rights.name=='superadmin' || req.session.user.rights.name=='admin'){%>
                        <a href="/products/<%= seller.id %>" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Ver Productos">
                          <span class="icon">
                            <i class='bx bxs-spreadsheet'></i>
                          </span>
                        </a>
                      <%}%>
                      <%if(req.session.user.rights.name=='superadmin' || req.session.user.rights.name=='admin'){%>
                        <a href="/showreports/<%= seller.id %>" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Ver Reportes">
                          <span class="icon">
                            <i class='bx bxs-report'></i>
                          </span>
                        </a>
                      <%}%>
                      <a id="productsdownload" sellerid="<%= seller.id %>" sellername="<%= seller.name %>" href="#" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Descargar Inventario">
                        <span class="icon">
                          <i class='bx bxs-file-export'></i>
                        </span>
                      </a>
                      <a href="/multiple/<%= seller.id %>" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Procesar productos">
                        <span class="icon">
                          <i class='bx bx-cloud-upload'></i>
                        </span>
                      </a>
                      <a href="/import/<%= seller.id %>" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Importar productos">
                        <span class="icon">
                          <i class='bx bx-import'></i>
                        </span>
                      </a>
                      <%if(req.session.user.rights.name=='superadmin' || req.session.user.rights.name=='admin'){%>
                        <a href="/channelmessages/<%= seller.id %>" class="button is-small has-tooltip-bottom has-tooltip-info" data-tooltip="Mensajería">
                          <span class="icon">
                            <i class='bx bxs-conversation'></i>
                          </span>
                        </a>
                      <%}%>
                    </td>
                </tr>
              <% }); %>
            </tbody>
        </table>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        let table = new simpleDatatables.DataTable('#sellers-table',{
        searchable:true,
        sortable:true,
        paging:true,
        labels: {
            placeholder: "Buscar...",
            perPage: "{select} registros por página",
            noRows: "No se encontraron datos",
            info: "Mostrando {start} a {end} de {rows} registros",
        }
        });  
      });

      live('#productsdownload','click', function(){
        let seller = this.getAttribute('sellerid');
        let name =  this.getAttribute('sellername');
        let loadingBlock = document.querySelector('#loading-donwload');
        if(hasClass(loadingBlock,'is-hidden')){removeClass(loadingBlock,'is-hidden');}
        io.socket.post('/products/download', {seller}, (resData, jwRes) =>{
          if(jwRes.statusCode == 200) {
            saveAs(new Blob([resData],{type:"application/octet-stream"}), `Inventario ${name}.xlsx`);
            addClass(loadingBlock,'is-hidden');
          }
        });
      });
    </script>
  <% } %>
  <script>
    setTimeout(function() {
      var el = document.getElementById('error');
      if(el){
        el.style.display='none';
      }
    }, 4000);

    live('#setup-import', 'click', function(e){
      e.preventDefault();

      var elm = this;
      var pane = document.getElementById('setup-panel');

      if (hasClass(pane, 'is-hidden')){
          removeClass(pane, 'is-hidden');
      }else{
          addClass(pane, 'is-hidden');
      }
    });

    live('.state', 'click', function(){
      if(confirm('Seguro Desea Continuar')){
        var elm = this;
        var id = this.getAttribute('seller');
        var status = null;
        if (hasClass(elm,'bx-check-circle')){status = false;}else{status = true;}

        io.socket.put('/seller/'+id,{active:status},function(resData, jwr){
          if(resData.active===false){
            removeClass(elm, 'bx-check-circle');
            addClass(elm,'bx-x-circle');
          }else{
            removeClass(elm, 'bx-x-circle');
            addClass(elm,'bx-check-circle');
          }
        });
      }
    });
    live('.modal-background, .delete, .modal-close','click',e=>{
      let modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        removeClass(modal,'is-active');
      });
    });
  </script>
</div>