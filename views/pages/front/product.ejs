<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/drift-zoom@1.4.0/dist/drift-basic.min.css">
<script src="https://cdn.jsdelivr.net/npm/drift-zoom@1.4.0/dist/Drift.min.js"></script>
<div class="container">
    <div class="columns">
        <div class="column is-two-fifths">
            <div class="box">
            <div class="media">
                <div class="media-left">
                    <%product.images.forEach((image)=>{%>
                        <figure class="image is-64x64">
                            <img src="/images/products/<%=product.id%>/<%= image.file.replace(image.file.split('.').pop(),'webp') %>" alt="<%=product.name%>">
                        </figure>
                    <%})%>
                </div>
                <%product.images.forEach((image)=>{%>
                    <%if(image.cover==1){%>
                        <div style="overflow-y: hidden;" class="media-content">
                            <figure class="image is-square is-relative">
                                <img id="main" src="/images/products/<%=product.id%>/<%= image.file.replace(image.file.split('.').pop(),'webp') %>" data-zoom="/images/products/<%=product.id%>/<%= image.file.replace(image.file.split('.').pop(),'webp') %>" alt="<%=product.name%>">
                            </figure>                        
                        </div>
                    <%}%>
                <%})%>
            </div>
        </div>
        </div>
        <div class="column is-two-fifths">
            <div class="container">
                <h2 class="is-capitalized"><%=product.manufacturer.name%></h2>
                <h4 class="is-uppercase is-size-4"><%=product.name%></h4>
                <hr>
                <table class="table is-size-6">
                    <%if(discount!==null){%><tr><td>Precio recomendado:</td><td><span class="is-size-7 has-text-danger old-price">$&nbsp;<%= Math.round((product.price*(1+(product.tax.value/100)))).toLocaleString("es-CO");%></span></td></tr><%}%>
                    <%let disc = Math.round((product.price*((100-discount.value)/100))*(1+(product.tax.value/100))).toLocaleString("es-CO")%>
                    <tr><td>Precio:</td><td>$&nbsp;<%= disc %></td></tr>
                    <%if(discount!==null){%>
                    <% let savings = parseInt(product.price*(1+(product.tax.value/100)))-parseInt((product.price*((100-discount.value)/100))*(1+(product.tax.value/100))) %>
                    <tr><td>Ahorro:</td><td class="has-text-success">$&nbsp;<%= savings.toLocaleString('es-CO'); %></td></tr>
                    <%}%>
                </table>
                <div class="columns is-mobile">
                    <div class="column">
                        <label class="label has-text-weight-bold is-size-7" for="variations">Talla:</label>
                        <div class="select is-primary is-small">
                        <select class="is-uppercase" name="variations">
                            <option class="is-capitalized" value="0">Seleccionar</option>
                            <% product.variations.forEach((vr)=>{%>
                                <option class="is-uppercase" qty="<%=vr.quantity%>" value="<%=vr.id%>"><%=vr.variation.name%></option>
                            <%})%>
                        </select>
                        </div>
                    </div>
                    <div class="column">
                        <label class="label has-text-weight-bold is-size-7" for="variations">Colores:</label>
                        <span class="color-container is-right is-inline-block" color="<%=product.mainColor.name%>" style="background-color: <%= product.mainColor.code %>;border:solid 1px; <%= product.mainColor.code %>;"></span>                        
                    </div>
                </div>
                <div class="content description-short"><%-product.descriptionShort%></div>
                <div class="img-zoom"></div>
            </div>
        </div>
        <div class="column is-one-fifth has-text-centered">
            <div class="box">
                <p id="avail" class="has-text-centered">Para comprar elige <b>Talla</b></p>
                <div class="select is-small is-hidden">                    
                <select name="quantity">
                </select>
                </div>
                <br><br>
                <div class="buttons is-centered">
                    <button id="add-to-cart" product="<%=product.id%>" disabled="disabled" class="button is-size-5 is-size-6-tablet has-text-weight-bold"><i class='bx bx-cart-alt is-size-5 is-dark'></i> &nbsp;Agregar al carrito</button>
                </div>
            </div>
        </div>
    </div>
    <hr>
    <div class="columns">
        <div class="column">
            <h4 class="is-size-4 has-text-weight-bold">Descripci√≥n del Producto</h4>
            <div class="content description"><%-product.description%></div>
        </div>
    </div>
</div>
<script>
    const figure = document.querySelectorAll('.media-left > figure')
    let showimage = (e) =>{
        let main = document.querySelector('#main');
        main.setAttribute('data-zoom',e.target.src);
        main.src=e.target.src;
    }
    for(let f of figure){
        f.addEventListener("mouseover",showimage);
        f.addEventListener("click",showimage);
    }

    
    let drift = new Drift(document.querySelector('#main'),{
        paneContainer: document.querySelector('.img-zoom')
    });

    live('select[name="variations"]','change',(e)=>{
        let stock = e.target.options[e.target.selectedIndex].getAttribute('qty');
        let quantity = document.querySelector('select[name="quantity"]');
        let label = document.querySelector('#avail');
        let add = document.querySelector('#add-to-cart');
        quantity.innerHTML='';
        if(e.target.options[e.target.selectedIndex].value > 0){
            if(stock>=1){
                label.innerHTML='Disponible.'
                removeClass(label, 'has-text-danger');
                removeClass(quantity.parentNode, 'is-hidden');
                addClass(label, 'has-text-success');
                addClass(add,'is-warning');
                for(let i=1;i<=stock;i++){
                    let op = document.createElement('option');
                    op.value=i;
                    op.innerHTML='Cantidad:&nbsp;'+i;
                    quantity.append(op);
                }
                if(stock==1){
                    label.innerHTML='Solo queda 1 disponible'
                    removeClass(label, 'has-text-success');
                    addClass(label, 'has-text-danger');
                }
                add.disabled=false;
            } else {
                label.innerHTML='No hay unidades Disponibles'
                removeClass(label, 'has-text-success');
                addClass(label, 'has-text-danger');
                addClass(quantity.parentNode,'is-hidden');
                removeClass(add,'is-warning');
                add.disabled=true;
            }
        }else{
            label.innerHTML='Para comprar elige <b>Talla</b>';
            removeClass(label, 'has-text-success');
            removeClass(label, 'has-text-danger');
            addClass(quantity.parentNode,'is-hidden');
            removeClass(add,'is-warning');
            add.disabled=true;
        }
    })

    live('#add-to-cart','click',(e)=>{
        let qty = document.querySelector('select[name="quantity"]').value
        let vrt = document.querySelector('select[name="variations"]').value
        io.socket.put('/cart',{variation:vrt,quantity:qty,action:'create'});
    })

</script>